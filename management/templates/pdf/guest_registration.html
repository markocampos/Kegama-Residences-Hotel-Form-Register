{% load humanize %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Kegama Registration Form</title>
    <style>
        @page {
            size: Letter;
            margin: 0mm;
        }
        
        body {
            margin: 0 auto;
            padding: 5mm 0; /* Top/Bottom padding */
            width: 100%;
            max-width: 195mm;
            font-family: "Helvetica", "Arial", sans-serif; 
            font-size: 10px;
            color: #1a1a1a;
            line-height: 1.2;
        }

        /* UTILITIES */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .font-bold { font-weight: bold; }
        .w-full { width: 100%; }
        
        table {
            border-collapse: collapse;
            border-spacing: 0;
        }
        
        /* HEADER SECTION */
        .header-top {
            width: 100%;
            margin-top: 0; /* Explicitly remove top margin */
            margin-bottom: 10px; /* Reduced margin */
            font-size: 9px;
        }

        /* THE IMAGE IN THE MIDDLE */
        .logo-container {
            text-align: center;
            margin-bottom: 5px; /* Reduced margin */
        }
        
        .logo-img {
            width: 180px; /* Reduced logo size */
            display: block;
            margin: 0 auto;
        }

        .sub-header {
            font-family: "Times New Roman", serif;
            font-weight: bold;
            font-size: 12px; /* Reduced font size */
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-top: 5px;
            color: #ea580c; /* Original Orange 600 */
        }

        /* CHECKBOXES */
        .checkbox-square {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 1px solid #333;
            margin-right: 4px;
            vertical-align: middle;
            text-align: center;
            line-height: 12px;
            position: relative;
        }
        .checked::after {
            content: "X"; /* Unicode Checkmark */
            font-size: 14px;
            font-weight: bold;
            color: #ea580c;
            position: absolute;
            top: 0;
            left: 0;
            width: 12px;
            text-align: center;
            line-height: 12px;
        }

        /* INPUT FIELDS */
        table.form-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 6px; /* More breathing room */
        }
        
        td.label {
            font-weight: bold;
            color: #374151; /* Dark gray */
            padding-right: 8px;
            white-space: nowrap;
            width: 1%;
            vertical-align: bottom;
            padding-bottom: 2px;
        }

        td.input-line {
            border-bottom: 1px solid #4b5563;
            font-family: "Courier New", monospace;
            font-size: 13px; /* Smaller but still prominent */
            vertical-align: bottom;
            padding-left: 10px;
            width: 99%;
            color: #000;
        }

        /* MAIN BOX */
        .main-border {
            border: 2px solid #000000; /* Original Orange border */
            padding: 12px; /* Reduced padding */
            height: auto;
            min-height: 500px; /* Reduced min-height */
            position: relative;
        }

        /* DATES SECTION */
        .dates-section {
            border-top: 1px solid #000000;
            border-bottom: 1px solid #000000;
            margin-top: 12px; /* Reduced margin */
            padding: 4px 0; /* Reduced padding */
        }

        /* POLICY BOX */
        .policy-container {
            width: 100%;
            margin-top: 12px; /* Reduced margin */
            vertical-align: bottom;
        }
        
        .policy-box {
            border: 1px solid #000000; /* Original Amber 600 */
            padding: 6px; /* Reduced padding */
            font-size: 8px; /* Reduced font size */
            width: 58%;
            vertical-align: top;
            line-height: 1.1;
        }

        /* SIGNATURE AREA */
        .signature-box {
            width: 40%;
            padding-left: 20px;
            vertical-align: bottom;
            text-align: center;
        }

        .signature-line {
            border-top: 1px solid #000;
            width: 100%;
            margin-top: 30px; /* Reduced margin */
            padding-top: 2px;
        }
    </style>
</head>
<body>

    <table class="header-top">
        <tr>
            <td style="width: 60%;">
                <span class="checkbox-square {% if guest.source == 'OYO' %}checked{% endif %}"></span> OYO &nbsp;
                <span class="checkbox-square {% if guest.source == 'AIRBNB' %}checked{% endif %}"></span> AIRBNB &nbsp;
                <span class="checkbox-square {% if guest.source == 'WALKIN' %}checked{% endif %}"></span> PAGE/WALK-IN
            </td>
            <td class="text-right">
                <b>SECURITY DEPOSIT:</b> P <u style="font-family: 'Courier New'; font-size: 12px;">{{ guest.security_deposit|intcomma|default:"Error" }}</u>
            </td>
        </tr>
    </table>

    <div class="logo-container">
        <!-- Replaced file:// protocol with static path handled by weasyprint's helpers usually, but standard django static tag is better if configured right. 
             For simplicity in this snippet, we will assume weasyprint base_url handling or relative paths. -->
        <img src="file://{{ base_dir }}/static/images/logo.png" class="logo-img" alt="KEGAMA Residences">
        
        <div class="sub-header">REGISTRATION FORM</div>
    </div>

    <table class="w-full" style="margin-bottom: 10px;">
        <tr>
            <td style="width: 50%;">
                <b>Date: Today:</b> <span style="font-family: 'Courier New'; text-decoration: underline;">{% now "M d, Y" %}</span>
            </td>
            <td class="text-right">
                <b>BOOKING ID #</b> <span style="border-bottom: 1px solid #000; padding: 0 5px; font-family: 'Courier New';">{{ guest.booking_id }}</span>
            </td>
        </tr>
    </table>

    <div class="main-border">
        
        <table class="form-table">
            <tr>
                <td class="label">Last Name</td>
                <td class="input-line">{{ guest.last_name|upper }}</td>
            </tr>
        </table>

        <table class="form-table">
            <tr>
                <td class="label">First Name</td>
                <td class="input-line">{{ guest.first_name|upper }}</td>
            </tr>
        </table>

        <table class="form-table">
            <tr>
                <td class="label">Address</td>
                <td class="input-line">{{ guest.address|upper }}</td>
            </tr>
        </table>

        <table class="w-full" style="margin-bottom: 6px; border-collapse: collapse;">
            <tr>
                <td class="label" style="width: 1%;">Phone</td>
                <td class="input-line" style="width: 35%;">
                    {% if ' ' in guest.phone %}
                        {{ guest.phone }}
                    {% else %}
                        {{ guest.phone|slice:":4" }} {{ guest.phone|slice:"4:7" }} {{ guest.phone|slice:"7:" }}
                    {% endif %}
                </td>
                <td style="width: 4%;"></td>
                <td class="label" style="width: 1%;">Email</td>
                <td class="input-line" style="width: 59%;">{{ guest.email }}</td>
            </tr>
        </table>

        <table class="w-full" style="margin-bottom: 12px; border-collapse: collapse;">
            <tr>
                <td class="label" style="width: 1%;">Birth date</td>
                <td class="input-line" style="width: 30%;">{{ guest.birth_date|date:"F d, Y" }}</td>
                <td style="width: 4%;"></td>
                <td class="label" style="width: 1%;">Car Plate</td>
                <td class="input-line" style="width: 64%;">{{ guest.car_plate|default:"" }}</td>
            </tr>
        </table>

        <table class="w-full" style="margin-bottom: 12px; border-collapse: collapse;">
            <tr>
                <td class="label" style="width: 1%;">Gender</td>
                <td class="input-line" style="width: 12%;">{{ guest.gender }}</td>
                <td style="width: 2%;"></td>

                <td class="label" style="width: 1%;">Room</td>
                <td class="input-line" style="width: 12%;">{{ guest.room_number }}</td>
                <td style="width: 2%;"></td>
                
                <td class="label" style="width: 1%;">No. of PAX</td>
                <td class="input-line" style="width: 8%; text-align: center;">{{ guest.pax }}</td>
                <td style="width: 2%;"></td>
                
                <td class="label" style="width: 1%;">No. of Nights</td>
                <td class="input-line" style="width: 10%; text-align: center;">
                    {% if guest.nights == 0 %}Short Stay{% else %}{{ guest.nights }}{% endif %}
                </td>
                <td style="width: 2%;"></td>
                
                <td class="label" style="width: 1%;">Duration</td>
                <td class="input-line" style="width: 10%; text-align: center;">{{ guest.stay_duration }}</td>
            </tr>
        </table>

        <div class="dates-section">
            <table style="width: 100%; border-collapse: collapse;">
                <tr>
                    <td class="label" style="width: 1%; padding-left: 10px;">Check-in&nbsp;DATE:</td>
                    <td class="input-line" style="width: 35%;">{{ guest.check_in_date|date:"M d, Y" }}</td>
                    <td class="label" style="width: 1%; padding-left: 40px;">TIME:</td>
                    <td class="input-line" style="width: 25%;">{{ guest.check_in_time|default:"" }}</td>
                    <td></td> <!-- Absorbs remaining space -->
                </tr>
                <tr><td colspan="5" style="height: 12px;"></td></tr>
                <tr>
                    <td class="label" style="width: 1%; padding-left: 10px;">Check-out&nbsp;DATE:</td>
                    <td class="input-line" style="width: 35%;"></td>
                    <td class="label" style="width: 1%; padding-left: 40px;">TIME:</td>
                    <td class="input-line" style="width: 25%;"></td>
                    <td></td> <!-- Absorbs remaining space -->
                </tr>
            </table>
        </div>

        {% if guest.notes %}
        <div style="margin-top: 15px; border: 1px dashed #000000; padding: 8px;">
            <div style="font-weight: bold; font-size: 10px; color: #000000; margin-bottom: 4px;">NOTES / REMARKS:</div>
            <div style="font-family: 'Courier New', monospace; font-size: 11px;">{{ guest.notes|linebreaksbr }}</div>
        </div>
        {% endif %}

        <table class="policy-container">
            <tr>
                <td class="policy-box">
                    <div style="font-weight: bold; margin-bottom: 4px;">Kegama Reservation Policy</div>
                    
                    <div style="white-space: pre-wrap;">{{ policy_text }}</div>

                    <div class="text-center" style="margin-top: 8px; font-family: 'Brush Script MT', cursive; font-size: 14px;">
                        Affordable yet Luxurious
                    </div>
                </td>

                <td class="signature-box">
                    <div class="signature-line"></div>
                    <div style="font-weight: bold; font-size: 10px;">SIGNATURE</div>

                    <div class="signature-line" style="margin-top: 35px; border-top: none; border-bottom: 1px solid #000;">
                        <span style="font-family: 'Courier New'; font-size: 14px; text-transform: uppercase;">
                            {{ guest.first_name }} {{ guest.last_name }}
                        </span>
                    </div>
                    <div style="font-weight: bold; font-size: 10px; margin-top: 2px;">PRINTED NAME</div>
                </td>
            </tr>
        </table>

        <!-- SLIP SECTION -->
        <div style="margin-top: 25px; border-top: 2px dashed #000000; padding-top: 15px;">
            <div style="font-weight: bold; text-align: center; color: #000000; margin-bottom: 10px; font-size: 12px;">PAYMENT DETAILS</div>
            
            <table style="width: 100%; border-collapse: collapse; font-family: 'Courier New', monospace; font-size: 11px;">
                <tr>
                    <td style="padding: 4px; font-weight: bold;">
                        Room {{ guest.room_number }} 
                        ({% if guest.nights == 0 %}Short Stay{% else %}{{ guest.nights }} Nights{% endif %} @ {{ guest.room_rate|intcomma }})
                    </td>
                    <td class="text-right" style="padding: 4px;">{{ room_total|floatformat:2|intcomma }}</td>
                </tr>
                
                <tr>
                    <td style="padding: 4px; color: #666; font-size: 10px;">Payment Mode: <span style="font-weight:bold; color:#000;">{{ guest.get_mode_of_payment_display }}</span></td>
                    <td class="text-right" style="padding: 4px;"></td>
                </tr>

                {% for req in requests_list %}
                <tr>
                    <td style="padding: 4px;">Add: {{ req.item }}</td>
                    <td class="text-right" style="padding: 4px;">{{ req.price|floatformat:2|intcomma }}</td>
                </tr>
                {% endfor %}

                <tr style="border-top: 2px solid #000000; font-weight: bold; font-size: 13px;">
                    <td style="padding: 10px 4px;">TOTAL AMOUNT</td>
                    <td class="text-right" style="padding: 10px 4px;">P {{ grand_total|floatformat:2|intcomma }}</td>
                </tr>
            </table>
            
            <div style="margin-top: 10px; font-size: 9px; text-align: center; color: #666;">
                Guest: {{ guest.first_name }} {{ guest.last_name }} | Generated: {% now "M d, Y H:i" %}
            </div>
        </div>

    </div>
</body>
</html>