{% extends 'management/base.html' %}
{% load humanize %}

{% block title %}Timeline | Kegama{% endblock %}

{% block content %}
<div class="min-h-screen bg-white flex flex-col overflow-hidden">
    
    <!-- Modern Desktop Header -->
    <nav class="bg-white border-b border-gray-200 px-6 py-4 sticky top-0 z-20 flex justify-between items-center backdrop-blur-md bg-white/90 shadow-sm">
        <div class="flex items-center gap-4">
            <a href="{% url 'dashboard' %}" class="flex items-center gap-2 text-gray-400 hover:text-orange-600 transition-all group">
                <svg class="w-5 h-5 transform group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                <span class="font-bold text-sm">Dashboard</span>
            </a>
            <div class="h-4 w-[1px] bg-gray-200"></div>
            
            <div class="flex items-center gap-3">
                <h2 class="font-bold text-lg tracking-tight text-gray-900">{{ current_month|date:"F Y"|upper }}</h2>
                <div class="flex gap-0.5 ml-2">
                    <a href="?month={{ prev_month.month }}&year={{ prev_month.year }}" class="p-1 hover:bg-gray-50 rounded transition-colors">
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    </a>
                    <a href="?month={{ next_month.month }}&year={{ next_month.year }}" class="p-1 hover:bg-gray-50 rounded transition-colors">
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </a>
                </div>
            </div>
        </div>
        
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-3">
                <a href="{% url 'print_timeline' %}?month={{ current_month.month }}&year={{ current_month.year }}" target="_blank" 
                   class="text-xs font-bold text-gray-500 hover:text-orange-600 px-6 py-3 rounded-2xl transition-all uppercase tracking-wide">
                    Export PDF
                </a>
                <a href="{% url 'new_booking' %}" 
                   class="bg-gray-900 text-white text-xs font-bold uppercase tracking-wider px-8 py-3.5 rounded-xl hover:bg-orange-600 transition-all shadow-lg shadow-gray-200 active:scale-95">
                    + New Booking
                </a>
            </div>
        </div>
    </nav>

    <!-- Timeline Grid -->
    <div class="flex-grow overflow-auto bg-white custom-scrollbar" style="overflow-x: auto; overflow-y: auto;">
        <div class="inline-block min-w-full align-middle" style="overflow: visible;">
            <table class="border-collapse table-fixed w-full" style="overflow: visible;">
                <thead>
                    <tr class="bg-white border-b border-gray-100">
                        <!-- Sticky Header with Shadow -->
                        <th class="sticky left-0 z-50 bg-white border-r border-gray-100 px-4 py-3 w-24 text-left shadow-[4px_0_15px_-3px_rgba(0,0,0,0.05)]">
                            <span class="text-[9px] font-bold text-gray-400 uppercase tracking-widest">Room</span>
                        </th>
                        {% for day in days_range %}
                        <th class="px-0.5 py-3 w-9 text-center border-r border-gray-50 transition-colors
                                   {% if day == today %}bg-orange-50/50{% endif %}">
                            <div class="text-[8px] font-bold uppercase tracking-wide {% if day == today %}text-orange-600{% else %}text-gray-400{% endif %}">
                                {{ day|date:"D"|slice:":1" }}
                            </div>
                            <div class="text-[11px] font-bold {% if day == today %}text-orange-600{% else %}text-gray-700{% endif %}">
                                {{ day.day }}
                            </div>
                        </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody class="divide-y-0" style="overflow: visible;">
                    {% for room in rooms %}
                    <tr class="group transition-colors border-b border-gray-100 {% if room.status == 'AVAILABLE' %}bg-emerald-50/10{% elif room.status == 'OCCUPIED' %}bg-gray-50/30{% else %}bg-gray-100/30{% endif %}" style="overflow: visible;">
                        
                        <!-- Status-Colored Sticky Room Column with Shadow -->
                        <td class="sticky left-0 z-50 border-r border-b border-gray-100 px-4 py-2 transition-all shadow-[4px_0_15px_-3px_rgba(0,0,0,0.05)]
                                   {% if room.is_occupied_today %}bg-gray-900 text-white{% elif room.status == 'MAINTENANCE' %}bg-gray-200 text-gray-500{% else %}bg-emerald-500 text-white{% endif %}">
                            <span class="font-bold text-xs tracking-tight block">{{ room.number }}</span>
                        </td>
                        
                        {% for day in days_range %}
                        {% with is_first_day=forloop.first %}
                        <td class="relative h-10 border-r border-b border-gray-100 p-0 group/cell transition-all" style="overflow: visible; z-index: {{ forloop.revcounter }};">
                            <!-- New Booking Hover Trigger -->
                            <a href="{% url 'new_booking' %}?room={{ room.number }}&date={{ day|date:'Y-m-d' }}" 
                               class="absolute inset-0 z-0 flex items-center justify-center opacity-0 group-hover/cell:opacity-100 transition-all bg-gray-50/50">
                                <svg class="w-3 h-3 text-orange-500 scale-75 group-hover/cell:scale-100 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4"></path></svg>
                            </a>

                            <!-- Gantt Bars -->
                            <div class="relative z-10 h-full w-full pointer-events-none" style="overflow: visible;">
                                {% for r_num, guests in booking_map.items %}
                                    {% if r_num == room.number %}
                                        {% for g in guests %}
                                            {% if g.check_in_date <= day and day <= g.end_night %}
                                                <!-- Bar Segment -->
                                                <a href="{% url 'update_guest' g.id %}" class="block absolute inset-0 pointer-events-auto transition-transform hover:scale-[1.02] hover:z-50
                                                   {% if g.status == 'PENDING' %}bg-yellow-400 border-yellow-500{% else %}bg-gray-800 border-gray-900{% endif %}
                                                   {% if g.check_in_date == day %}rounded-l-md border-l border-y z-20 ml-0.5{% else %}border-y z-10{% endif %}
                                                   {% if g.end_night == day %}rounded-r-md border-r mr-0.5{% endif %}"
                                                   style="overflow: visible;">
                                                    
                                                    {% if g.check_in_date == day or is_first_day and g.check_in_date < day %}
                                                        <span class="absolute left-1 inset-y-0 flex items-center z-[60] text-[9px] font-bold tracking-wide whitespace-nowrap px-2 py-0.5 rounded text-white shadow-sm"
                                                           style="height: fit-content; margin: auto 0; text-shadow: 0 1px 2px rgba(0,0,0,0.5);">
                                                            {{ g.last_name|title }}
                                                        </span>
                                                    {% endif %}
                                                </a>
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </td>
                        {% endwith %}
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
    .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #d1d5db; }
</style>
{% endblock %}