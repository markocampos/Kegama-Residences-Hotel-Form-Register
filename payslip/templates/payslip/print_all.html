{% extends "management/base.html" %}
{% load humanize %}

{% block title %}Bulk Print - 4-per-page{% endblock %}

{% block content %}
<style>
    /* UI SETTINGS */
    .print-all-wrapper {
        background-color: #f3f4f6;
        padding: 24px;
        min-height: 100vh;
        font-family: 'Inter', sans-serif;
    }

    .top-bar {
        position: sticky; top: 16px; z-index: 50;
        background: white; border-radius: 16px; 
        box-shadow: 0 4px 20px -2px rgba(0,0,0,0.1);
        border: 1px solid #e5e7eb;
        padding: 16px 24px;
        margin-bottom: 32px;
        display: flex; flex-direction: column; gap: 16px;
        max-width: 1000px; margin-left: auto; margin-right: auto;
    }
    
    @media(min-width: 768px) {
        .top-bar { flex-direction: row; justify-content: space-between; align-items: center; }
    }

    .filter-select {
        border: 1px solid #e5e7eb; border-radius: 8px; padding: 10px 12px; font-size: 0.9rem;
        background-color: #f9fafb; color: #1f2937; transition: all 0.2s;
        min-width: 200px;
    }
    .filter-select:focus { outline: none; border-color: #ea580c; background: white; }

    .btn-print {
        background: #111827; color: white; padding: 12px 24px; border-radius: 10px;
        font-weight: 700; font-size: 0.9rem; border: none; cursor: pointer;
        display: inline-flex; align-items: center; gap: 8px;
        transition: all 0.2s; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
    }
    .btn-print:hover { background: #000; transform: translateY(-1px); }

    /* THE PRINT GRID */
    .slips-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 24px; 
        max-width: 1000px; 
        margin: 0 auto;
    }

    @media (min-width: 768px) {
        .slips-grid {
            grid-template-columns: 1fr 1fr; 
            max-width: 210mm; /* A4 width simulation */
            gap: 15px;
        }
    }

    .mini-slip {
        background: white;
        border: 1px solid #e5e7eb; 
        padding: 20px;
        color: #000;
        display: flex;
        flex-direction: column;
        min-height: auto; 
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
        position: relative; /* Added for ID positioning */
        transition: transform 0.2s;
    }
    
    .slip-id {
        position: absolute;
        top: 15px;
        right: 15px;
        font-size: 0.65rem;
        font-weight: 800;
        color: #9ca3af;
    }
    
    .mini-slip:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
    
    .mini-slip.empty-state { opacity: 0.7; border-style: dashed; background-color: #fafafa; box-shadow: none; }
    
    .no-data-badge {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: #f3f4f6; padding: 8px 16px; border-radius: 999px;
        font-size: 0.7rem; font-weight: 800; color: #6b7280; letter-spacing: 0.05em;
        border: 1px solid #e5e7eb; pointer-events: none; text-transform: uppercase;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    /* Print Specific Styles - Keep Clean */
    .header { text-align: center; margin-bottom: 12px; border-bottom: 2px solid #000; padding-bottom: 6px; }
    .co-name { font-weight: 900; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em; }
    .doc-type { font-size: 0.6rem; font-weight: 700; color: #4b5563; text-transform: uppercase; }
    
    .info-section { 
        display: grid; 
        grid-template-columns: auto 1fr; 
        gap: 6px 12px; 
        font-size: 0.7rem; 
        margin-bottom: 12px;
        padding-bottom: 12px;
        border-bottom: 1px solid #000;
    }
    
    @media (min-width: 640px) {
        .info-section { grid-template-columns: auto 1fr auto 1fr; }
    }

    .label { font-weight: 800; font-size: 0.55rem; text-transform: uppercase; color: #6b7280; }
    .val { font-weight: 600; }

    .body-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; flex-grow: 1; }
    
    .sec-title { 
        font-weight: 800; font-size: 0.6rem; text-transform: uppercase;
        border-bottom: 1.5px solid #000; margin-bottom: 8px; display: block;
        padding-bottom: 2px;
    }

    .line { display: flex; justify-content: space-between; font-size: 0.65rem; margin-bottom: 4px; }
    .line span:last-child { font-family: 'Courier New', monospace; font-weight: 700; }

    .total-row { 
        border-top: 1.5px solid #000; margin-top: 8px; padding-top: 4px;
        font-weight: 900; display: flex; justify-content: space-between; font-size: 0.7rem;
    }

    .footer { margin-top: 16px; }
    .net-box { 
        border: 2px solid #000; padding: 10px; margin-bottom: 16px;
        display: flex; justify-content: space-between; align-items: center;
        background: #f9fafb; /* Slight grey bg on screen */
    }
    .net-label { font-weight: 900; font-size: 0.75rem; text-transform: uppercase; }
    .net-amount { font-size: 1rem; font-weight: 900; }
    
    .sig-area { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
    .sig-line { 
        border-top: 1px solid #000; margin-top: 24px; text-align: center; 
        font-size: 0.5rem; font-weight: 700; text-transform: uppercase; padding-top: 4px; color: #4b5563;
    }

        /* PRINT OVERRIDES */

        @media print {

            @page { 

                margin: 0; 

                size: portrait; 

            }

            body { 

                margin: 10mm; 

                background: white !important; 

            }

            .print-all-wrapper { background: white !important; padding: 0 !important; margin: 0 !important; }

            .no-print, .top-bar { display: none !important; }
        
        .slips-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            grid-template-rows: calc(50vh - 15mm) calc(50vh - 15mm);
            gap: 10mm 15mm; 
            width: 100%; height: 100vh;
            border: none; max-width: none;
        }

        .mini-slip { 
            border: 1px solid #000; page-break-inside: avoid;
            box-shadow: none; border-radius: 0; height: 100%;
            opacity: 1 !important; background-color: white !important; border-style: solid !important;
            padding: 15px; transform: none !important;
        }
        
        .no-data-badge { display: none !important; }
        .net-box { background: transparent !important; }
        
        .info-section { grid-template-columns: auto 1fr auto 1fr; }
    }
</style>

<div class="print-all-wrapper">
    <div class="top-bar">
        <div class="flex items-center gap-4 w-full md:w-auto">
            <a href="{% url 'payslip:index' %}" class="text-sm font-bold text-gray-400 hover:text-gray-900 flex items-center transition-colors">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                Back
            </a>
            
            <form method="GET" class="flex-1">
                <select name="period" onchange="this.form.submit()" class="filter-select w-full">
                    <option value="">Latest Records</option>
                    {% for p in available_periods %}
                    <option value="{{ p }}" {% if selected_period == p %}selected{% endif %}>{{ p }}</option>
                    {% endfor %}
                </select>
            </form>
        </div>

        <div class="flex flex-col items-center px-6 py-2 border-y md:border-y-0 md:border-x border-gray-100 w-full md:w-auto">
            <span class="text-[10px] font-black uppercase tracking-[0.2em] text-gray-400">Total Cash Needed</span>
            <span class="text-xl font-black text-orange-600">&#8369; {{ grand_total|floatformat:2|intcomma }}</span>
        </div>

        <button onclick="window.print()" class="btn-print w-full md:w-auto justify-center">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
            Print All Slips
        </button>
    </div>

    <div class="slips-grid">
        {% for item in employee_data %}
        {% with emp=item.employee payslip=item.payslip %}
        <div class="mini-slip {% if not payslip %}empty-state{% endif %}">
            <div class="slip-id">#{{ emp.id|stringformat:"s"|slice:":8" }}</div>
            
            {% if not payslip %}
            <div class="no-data-badge">
                No Record
            </div>
            {% endif %}

            <div class="header">
                <div class="co-name">KEGAMA RESIDENCES INC.</div>
                <div class="doc-type">Payslip</div>
            </div>

            <div class="info-section">
                <span class="label">Employee:</span>
                <span class="val">{{ emp.last_name }}, {{ emp.first_name }}</span>
                <span class="label">Position:</span>
                <span class="val">{{ emp.position|default:"-" }}</span>
                <span class="label">Date:</span>
                <span class="val">{{ payslip.pay_date|default:"-" }}</span>
                <span class="label">Period:</span>
                <span class="val">{{ payslip.pay_period|default:selected_period|default:"-" }}</span>
            </div>

            <div class="body-grid">
                <div class="col">
                    <span class="sec-title">Earnings</span>
                    <div class="line"><span>Regular Pay</span><span>{{ payslip.earning_regular|floatformat:2|intcomma|default:"0.00" }}</span></div>
                    <div class="line"><span>Holiday Pay</span><span>{{ payslip.earning_holiday|floatformat:2|intcomma|default:"0.00" }}</span></div>
                    <div class="line"><span>Overtime Pay</span><span>{{ payslip.earning_overtime|floatformat:2|intcomma|default:"0.00" }}</span></div>
                    <div class="line"><span>Allowances</span><span>{{ payslip.earning_allowances|floatformat:2|intcomma|default:"0.00" }}</span></div>
                    <div class="line"><span>13th Month</span><span>{{ payslip.earning_13th|floatformat:2|intcomma|default:"0.00" }}</span></div>
                    <div class="line"><span>Other Earnings</span><span>{{ payslip.earning_other|floatformat:2|intcomma|default:"0.00" }}</span></div>
                    <div class="total-row"><span>GROSS PAY</span><span>{{ payslip.total_earnings|floatformat:2|intcomma|default:"0.00" }}</span></div>
                </div>

                <div class="col">
                    <span class="sec-title">Deductions</span>
                    <div class="line"><span>SSS</span><span>{{ payslip.deduction_sss|floatformat:2|intcomma|default:"0.00" }}</span></div>
                    <div class="line"><span>PhilHealth</span><span>{{ payslip.deduction_philhealth|floatformat:2|intcomma|default:"0.00" }}</span></div>
                    <div class="line"><span>Pag-IBIG</span><span>{{ payslip.deduction_pagibig|floatformat:2|intcomma|default:"0.00" }}</span></div>
                    <div class="line"><span>Withholding Tax</span><span>{{ payslip.deduction_tax|floatformat:2|intcomma|default:"0.00" }}</span></div>
                    <div class="line"><span>Cash Advance</span><span>{{ payslip.deduction_cashadv|floatformat:2|intcomma|default:"0.00" }}</span></div>
                    <div class="line"><span>Other Deducts</span><span>{{ payslip.deduction_other|floatformat:2|intcomma|default:"0.00" }}</span></div>
                    <div class="total-row"><span>TOTAL DED.</span><span>{{ payslip.total_deductions|floatformat:2|intcomma|default:"0.00" }}</span></div>
                </div>
            </div>

            <div class="footer">
                <div class="net-box">
                    <span class="net-label">NET PAY:</span>
                    <span class="net-amount">&#8369; {{ payslip.net_pay|floatformat:2|intcomma|default:"0.00" }}</span>
                </div>
                <div class="sig-area">
                    <div class="sig-line">Authorized By</div>
                    <div class="sig-line">Employee Signature</div>
                </div>
            </div>
        </div>
        {% endwith %}
        {% endfor %}
    </div>
</div>
{% endblock %}
